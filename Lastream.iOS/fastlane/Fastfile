# Lastream iOS Fastfile
# This file defines the automation lanes for building and releasing the iOS app.

default_platform(:ios)

platform :ios do
  
  # ==================
  # Testing
  # ==================
  
  desc "Run all tests"
  lane :test do
    run_tests(
      project: "Lastream.xcodeproj",
      scheme: "Lastream",
      devices: ["iPhone 16"],
      code_coverage: true,
      result_bundle: true,
      output_directory: "./test_output",
      buildlog_path: "./test_output/logs"
    )
  end
  
  # ==================
  # Beta Deployment
  # ==================
  
  desc "Build and upload to TestFlight"
  lane :beta do
    setup_ci if ENV['CI']
    
    # Create App Store Connect API key
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
      is_key_content_base64: true
    )
    
    # Increment build number using timestamp
    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M"),
      xcodeproj: "Lastream.xcodeproj"
    )
    
    # Build the app
    build_app(
      project: "Lastream.xcodeproj",
      scheme: "Lastream",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Lastream.ipa",
      clean: true
    )
    
    # Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end
  
  # ==================
  # App Store Deployment
  # ==================
  
  desc "Deploy to App Store"
  lane :release do
    setup_ci if ENV['CI']
    
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
      is_key_content_base64: true
    )
    
    build_app(
      project: "Lastream.xcodeproj",
      scheme: "Lastream",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Lastream.ipa"
    )
    
    upload_to_app_store(
      api_key: api_key,
      submit_for_review: false,
      automatic_release: false,
      force: true,
      skip_metadata: true,
      skip_screenshots: true
    )
  end
  
  # ==================
  # Code Signing
  # ==================
  
  desc "Sync certificates and provisioning profiles"
  lane :sync_certificates do
    match(type: "development")
    match(type: "appstore")
  end
  
  desc "Register new devices"
  lane :register_device do |options|
    device_name = options[:name]
    device_udid = options[:udid]
    
    register_devices(
      devices: {
        device_name => device_udid
      }
    )
    
    match(type: "development", force_for_new_devices: true)
  end
  
  # ==================
  # Utilities
  # ==================
  
  desc "Increment version number"
  lane :bump_version do |options|
    type = options[:type] || "patch"
    
    increment_version_number(
      bump_type: type,
      xcodeproj: "Lastream.xcodeproj"
    )
    
    version = get_version_number(xcodeproj: "Lastream.xcodeproj")
    UI.success("Version bumped to #{version}")
  end
  
  desc "Clean build artifacts"
  lane :clean do
    clear_derived_data
    sh("rm -rf ../build")
    sh("rm -rf ../test_output")
  end
  
end
